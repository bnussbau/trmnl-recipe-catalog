<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSS Recipe Catalog for TRMNL</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <style>
    :root {
      --bg-color: #f9f9f9;
      --card-bg: #fff;
      --text-color: #333;
      --text-muted: #888;
      --border-color: #ddd;
      --shadow: rgba(0,0,0,0.07);
      --logo-bg: #eee;
      --accent-color: rgb(248, 101, 75);
      --accent-hover: rgb(200, 60, 40);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --card-bg: #2d2d2d;
        --text-color: #e0e0e0;
        --text-muted: #a0a0a0;
        --border-color: #444;
        --shadow: rgba(0,0,0,0.3);
        --logo-bg: #404040;
        --accent-color: rgb(255, 120, 95);
        --accent-hover: rgb(255, 140, 115);
      }
    }

    body { 
      background: var(--bg-color); 
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    input:focus { border-color: var(--accent-color) !important; }
    
    .container {
      max-width: 60rem;
    }
    
    
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
      padding: 1.5em;
      margin-bottom: 1.5em;
      display: flex;
      gap: 1.5em;
      align-items: flex-start;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card img.logo { 
      width: 64px; 
      height: 64px; 
      object-fit: contain; 
      border-radius: 6px; 
      background: var(--logo-bg);
      transition: background-color 0.3s ease;
    }
    
    .card-content { flex: 1; }
    .search-box { margin: 2em 0; }
    .card-title { margin: 0 0 0.5em 0; }
    .card-meta { color: var(--text-muted); font-size: 0.95em; margin-bottom: 0.5em; }
    .card-meta li { margin-bottom: 0; }
    
    .card-links a {
      margin-right: 1em;
      color: var(--accent-color) !important;
      transition: color 0.2s;
    }
    
    .card-links a:hover {
      color: var(--accent-hover) !important;
    }
    
    .funding-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .funding-dropdown-content {
      display: none;
      position: absolute;
      background: var(--card-bg);
      
      box-shadow: 0 4px 8px var(--shadow);
      border-radius: 6px;
      z-index: 1000;
      border: 1px solid var(--border-color);
      top: 100%;
      left: 0;
    }
    
    .funding-dropdown-content a {
      color: var(--text-color) !important;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }
    
    .funding-dropdown-content a:last-child {
      border-bottom: none;
    }
    
    .funding-dropdown:hover .funding-dropdown-content {
      display: block;
    }
    
    .button {
      transition: background-color 0.3s ease;
    }
    
    input[type="text"] {
      background: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    h2, h4 {
      color: var(--text-color);
      transition: color 0.3s ease;
    }
    
    p {
      color: var(--text-muted);
      transition: color 0.3s ease;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>OSS Recipe Catalog for TRMNL</h2>
    <div style="margin-bottom:1.5em;">
      <p style="font-size:1.1em; color:#555; margin-bottom:0.5em;">
        A community-driven catalog of repositories containing recipes for TRMNL.<br>
        The goal of this project is to collect TRMNLP-compatible recipes in public repositories and make them available as a catalog for BYOS.
      </p>
      <a href="https://github.com/bnussbau/trmnl-recipe-catalog/blob/main/CONTRIBUTING.md" class="button" style="background:rgb(248,101,75);color:#fff;border:none;">Add a recipe</a>
    </div>
    <div style="display:flex;align-items:center;gap:1em;margin-bottom:0.5em;">
      <input class="search-box" type="text" id="search" placeholder="Search by author or title..." style="width:100%;max-width:400px;">
      <span id="recipe-count" style="margin-left:auto;"></span>
    </div>
    <div id="cards"></div>
  </div>
  <script>
    async function fetchYAML() {
      const res = await fetch('https://raw.githubusercontent.com/bnussbau/trmnl-recipe-catalog/refs/heads/main/catalog.yaml');
      const text = await res.text();
      return jsyaml.load(text);
    }

    function byosLaravelHTML(byos) {
      if (!byos || !('compatibility' in byos)) return '';
      let icon = '', text = '';
      if (byos.compatibility === true) {
        icon = '✅';
        text = byos.min_version ? `(min. version: ${byos.min_version})` : '';
      } else if (byos.compatibility === false) {
        icon = '❌';
        text = byos.compatibility_note || '';
      } else {
        icon = '❓';
        text = '';
      }
      return `<li><span title="${text}">${icon}</span> BYOS Laravel ${text}</li>`;
    }

    function trmnlCoreHTML(trmnlp) {
      if (!trmnlp || !trmnlp.id) return '';
      const installLink = `<a href="https://usetrmnl.com/recipes/${trmnlp.id}" target="_blank" style="color: var(--accent-color) !important;">Install</a>`;
      return `<li><span title="Available in TRMNL Core">✅</span> TRMNL Core (Cloud service) – ${installLink}</li>`;
    }

    function compatibilityHTML(byos, trmnlp) {
      const byosHTML = byosLaravelHTML(byos);
      const trmnlCoreHTMLContent = trmnlCoreHTML(trmnlp);
      
      if (!byosHTML && !trmnlCoreHTMLContent) return '';
      
      return `<div class="card-meta"><strong>Compatibility:</strong><ul>${trmnlCoreHTMLContent}${byosHTML}</ul></div>`;
    }

    function resolveFundingUrl(platform, username) {
      const urlMap = {
        'community_bridge': `https://funding.communitybridge.org/projects/${username}`,
        'github': `https://github.com/sponsors/${username}`,
        'issuehunt': `https://issuehunt.io/r/${username}`,
        'ko_fi': `https://ko-fi.com/${username}`,
        'liberapay': `https://liberapay.com/${username}`,
        'open_collective': `https://opencollective.com/${username}`,
        'patreon': `https://patreon.com/${username}`,
        'tidelift': `https://tidelift.com/subscription/pkg/${username}`,
        'polar': `https://polar.sh/${username}`,
        'buy_me_a_coffee': `https://buymeacoffee.com/${username}`,
        'thanks_dev': `https://thanks.dev/u/gh/${username}`,
        'custom': username // Custom URLs are passed directly
      };
      return urlMap[platform] || '#';
    }

    function formatPlatformName(platform, username) {
      if (platform === 'custom') {
        return username;
      }
      return platform.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function fundingHTML(funding) {
      if (!funding || Object.keys(funding).length === 0) return '';
      
      const fundingOptions = Object.entries(funding).map(([platform, username]) => {
        const url = resolveFundingUrl(platform, username);
        const displayName = formatPlatformName(platform, username);
        return `<a href="${url}" target="_blank">${displayName}</a>`;
      }).join('');
      
      return `
        <div class="funding-dropdown">
          <a href="#" style="color: var(--accent-color) !important;">Fund</a>
          <div class="funding-dropdown-content">
            ${fundingOptions}
          </div>
        </div>
      `;
    }

    function cardHTML(key, entry) {
      const byos = entry.byos?.byos_laravel;
      const trmnlp = entry.trmnlp;
      const logoHTML = entry.logo_url
        ? `<img class="logo" src="${entry.logo_url}" alt="logo">`
        : `<span class="logo" style="display:inline-block;width:64px;height:64px;vertical-align:middle;background:#eee;border-radius:6px;">
            <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"#888\" style=\"width:100%;height:100%;\">
              <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 0 1-.657.643 48.39 48.39 0 0 1-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 0 1-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 0 0-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 0 1-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 0 0 .657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 0 1-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 0 0 5.427-.63 48.05 48.05 0 0 0 .582-4.717.532.532 0 0 0-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 0 0 .658-.663 48.422 48.422 0 0 0-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 0 1-.61-.58v0Z\" />
            </svg>
          </span>`;
      const screenshotPopover = entry.screenshot_url ? `
        <a href="#" popovertarget="popover-${key}" onclick="event.preventDefault(); document.getElementById('popover-${key}').showPopover();">Screenshot</a>
        <div id="popover-${key}" popover style="padding:0;max-width:800px;">
          <img src="${entry.screenshot_url}" alt="Screenshot" style="max-width:100%;display:block;border-radius:8px;">
        </div>
      ` : '';
      const fundingButton = fundingHTML(entry.funding);
      return `<div class="card">
        ${logoHTML}
        <div class="card-content">
          <h4 class="card-title">${entry.name || key}</h4>
          <div class="card-meta">
            <strong>Author:</strong> ${entry.author?.github || 'Unknown'}<br>
            <strong>License:</strong> ${entry.license || 'Unknown'}
          </div>
          ${compatibilityHTML(byos, trmnlp)}
          <div>${entry.author_bio?.description || ''}</div>
          <div class="card-links" style="margin-top:0.5em;">
            ${entry.trmnlp?.repo ? `<a href="${entry.trmnlp.repo}" target="_blank">Repo</a>` : ''}
            ${entry.trmnlp?.zip_url ? `<a href="${entry.trmnlp.zip_url}" target="_blank">Download ZIP</a>` : ''}
            ${entry.author_bio?.learn_more_url ? `<a href="${entry.author_bio.learn_more_url}" target="_blank">Learn More</a>` : ''}
            ${screenshotPopover}
            ${fundingButton}
          </div>
        </div>
      </div>`;
    }


    function renderCards(data, filter='') {
      const cards = document.getElementById('cards');
      const countSpan = document.getElementById('recipe-count');
      const filterLC = filter.toLowerCase();
      const sortedEntries = Object.entries(data)
        .sort((a, b) => {
          const nameA = (a[1].name || '').toLowerCase();
          const nameB = (b[1].name || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
      const filtered = sortedEntries.filter(([key, entry]) => {
        const title = (entry.name || '').toLowerCase();
        const author = (entry.author?.github || '').toLowerCase();
        return title.includes(filterLC) || author.includes(filterLC);
      });
      cards.innerHTML = filtered.map(([key, entry]) => cardHTML(key, entry)).join('') || '<p>No results found.</p>';
      if (countSpan) {
        if (filter && filter.trim() !== '') {
          countSpan.textContent = `${filtered.length} result${filtered.length === 1 ? '' : 's'}`;
        } else {
          countSpan.textContent = `${sortedEntries.length} recipe${sortedEntries.length === 1 ? '' : 's'}`;
        }
      }
    }

    fetchYAML().then(data => {
      window._catalogData = data;
      renderCards(data);
      document.getElementById('search').addEventListener('input', e => {
        renderCards(window._catalogData, e.target.value);
      });
    });
  </script>
</body>
</html>
